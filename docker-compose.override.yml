# Docker Compose Override for Development
# This file is automatically loaded by docker-compose and overrides settings in docker-compose.yml
# Use for local development with hot-reload and debugging features

services:
  # Manager - Development mode with hot reload
  manager:
    build:
      target: development
    volumes:
      # Mount source code for hot reload
      - ./manager:/app
      - manager_logs:/app/logs
      - ./certs:/app/certs:ro
    environment:
      # Development-specific settings
      - DEBUG=true
      - LOG_LEVEL=debug
      - MARCHPROXY_ENV=development
    ports:
      # Expose additional debugging ports
      - "8000:8000"   # Main application
      - "5678:5678"   # Python debugger (debugpy)

  # Proxy Egress - Development mode with hot reload
  proxy-egress:
    build:
      target: development
    volumes:
      # Mount source code for hot reload
      - ./proxy-egress:/app
      - proxy_egress_logs:/app/logs
      - ./certs:/app/certs:rw
    environment:
      # Development-specific settings
      - LOG_LEVEL=DEBUG
      - ENABLE_PROFILING=true
      - GO_ENV=development
      - MTLS_ENABLED=true
    ports:
      - "8080:8080"   # Proxy port
      - "8081:8081"   # Admin/Metrics port
      - "6060:6060"   # Go pprof profiling

  # Proxy Ingress - Development mode with hot reload
  proxy-ingress:
    build:
      target: development
    volumes:
      # Mount source code for hot reload
      - ./proxy-ingress:/app
      - proxy_ingress_logs:/app/logs
      - ./certs:/app/certs:rw
    environment:
      # Development-specific settings
      - LOG_LEVEL=DEBUG
      - ENABLE_PROFILING=true
      - GO_ENV=development
      - MTLS_ENABLED=true
    ports:
      - "80:80"       # HTTP port
      - "443:443"     # HTTPS/TLS port
      - "8082:8082"   # Admin/Metrics port
      - "6061:6060"   # Go pprof profiling (different port to avoid conflict)

  # Reduce resource requirements for development
  postgres:
    command: postgres -c shared_buffers=64MB -c max_connections=20

  redis:
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis123} --maxmemory 64mb

  # Disable some monitoring services in development to save resources
  # Uncomment these lines if you want to disable services for faster startup
  # elasticsearch:
  #   profiles: ["monitoring"]
  #
  # logstash:
  #   profiles: ["monitoring"]
  #
  # kibana:
  #   profiles: ["monitoring"]