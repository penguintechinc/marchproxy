# MarchProxy AMD GPU Override Configuration
# Use with: docker-compose -f docker-compose.yml -f docker-compose.gpu-amd.yml up
# Requires: ROCm and AMD GPU drivers installed on host

version: '3.8'

services:
  # RTMP Container with AMD GPU acceleration (ROCm)
  proxy-rtmp-amd:
    build:
      context: ./proxy-rtmp
      dockerfile: Dockerfile
      target: amd
    container_name: marchproxy-proxy-rtmp-amd
    profiles:
      - gpu-amd
      - rtmp-amd
    devices:
      - /dev/kfd:/dev/kfd  # Kernel Fusion Driver
      - /dev/dri:/dev/dri  # Direct Rendering Infrastructure
    group_add:
      - video
      - render
    environment:
      # API Server connection
      - API_SERVER_URL=http://api-server:8000
      - CLUSTER_API_KEY=${CLUSTER_API_KEY:-default-api-key}

      # gRPC server (ModuleService)
      - GRPC_PORT=50054
      - GRPC_BIND=0.0.0.0:50054

      # Module configuration
      - MODULE_TYPE=rtmp
      - MODULE_NAME=${RTMP_AMD_NAME:-proxy-rtmp-amd-1}
      - RTMP_PORT=1935
      - ADMIN_PORT=7005
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # AMD GPU configuration
      - GPU_ENABLED=true
      - GPU_TYPE=amd
      - HSA_OVERRIDE_GFX_VERSION=${HSA_OVERRIDE_GFX_VERSION:-}  # Set if needed for specific GPU
      - ROCR_VISIBLE_DEVICES=${ROCR_VISIBLE_DEVICES:-0}

      # FFmpeg AMD configuration
      - FFMPEG_THREADS=${FFMPEG_THREADS:-8}
      - TRANSCODE_PRESET=${TRANSCODE_PRESET:-medium}
      - VIDEO_CODEC=h264_amf  # AMD Media Framework encoder
      - VIDEO_CODEC_HEVC=hevc_amf  # AMD HEVC encoder
      - HWACCEL=vaapi  # Video Acceleration API
      - HWACCEL_DEVICE=/dev/dri/renderD128
      - VAAPI_DEVICE=/dev/dri/renderD128

      # AMF encoding settings
      - AMF_QUALITY=${AMF_QUALITY:-speed}  # speed, balanced, quality
      - AMF_USAGE=${AMF_USAGE:-transcoding}  # transcoding, ultralowlatency, lowlatency
      - AMF_PROFILE=${AMF_PROFILE:-main}  # baseline, main, high
      - AMF_RATE_CONTROL=${AMF_RATE_CONTROL:-vbr_latency}  # cqp, cbr, vbr_latency, vbr_peak
      - AMF_BITRATE=${AMF_BITRATE:-5M}

      # Output formats
      - HLS_ENABLED=${HLS_ENABLED:-true}
      - HLS_SEGMENT_DURATION=${HLS_SEGMENT_DURATION:-6}
      - DASH_ENABLED=${DASH_ENABLED:-true}
      - DASH_SEGMENT_DURATION=${DASH_SEGMENT_DURATION:-6}

      # Multi-bitrate support
      - MULTI_BITRATE_ENABLED=${MULTI_BITRATE_ENABLED:-true}
      - BITRATES=${BITRATES:-1M,2M,5M,10M}
      - RESOLUTIONS=${RESOLUTIONS:-640x360,1280x720,1920x1080,3840x2160}

      # Rate limiting per stream
      - RATE_LIMIT_ENABLED=${RTMP_RATE_LIMIT:-true}
      - MAX_STREAMS=${MAX_STREAMS:-10}

      # Observability
      - JAEGER_ENABLED=${JAEGER_ENABLED:-true}
      - JAEGER_HOST=jaeger
      - JAEGER_PORT=6831
    ports:
      - "1935:1935"   # RTMP
      - "8081:8081"   # HLS/DASH HTTP
      - "7005:7005"   # Admin/Metrics
      - "50054:50054" # gRPC ModuleService
    volumes:
      - rtmp_streams:/streams
    networks:
      - marchproxy-internal
    depends_on:
      - api-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7005/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "service=marchproxy-proxy-rtmp"
      - "component=proxy"
      - "layer=video"
      - "module=rtmp"
      - "variant=amd"
      - "gpu=true"

volumes:
  rtmp_streams:
    driver: local
