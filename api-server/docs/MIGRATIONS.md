# MarchProxy Database Migrations

Complete guide to database migrations using Alembic for MarchProxy API Server.

## Overview

MarchProxy uses [Alembic](https://alembic.sqlalchemy.org/) for database schema versioning and migrations. This provides:

- Version control for database schema changes
- Repeatable, reversible migrations
- Async SQLAlchemy support
- Automatic schema generation from SQLAlchemy models
- Development and production deployment safety

## Quick Start

### Apply Latest Migrations

```bash
cd /path/to/api-server
./scripts/migrate.sh
```

### Check Migration Status

```bash
./scripts/migrate-status.sh
```

### Downgrade One Step

```bash
./scripts/migrate-down.sh -1
```

### Create New Migration

```bash
./scripts/migrate-create.sh "Add new table description"
```

## Configuration

### Alembic Configuration File

**Location**: `/api-server/alembic.ini`

Key configuration:
```ini
[alembic]
script_location = alembic
sqlalchemy.url = postgresql+asyncpg://user:password@host:5432/db

[loggers]
level = INFO
```

### Database URL Format

- **Development**: `postgresql+asyncpg://marchproxy:marchproxy@localhost:5432/marchproxy`
- **Docker**: `postgresql+asyncpg://marchproxy:marchproxy@postgres:5432/marchproxy`
- **Production**: `postgresql+asyncpg://user:password@prod-host:5432/marchproxy`

The URL format is: `postgresql+asyncpg://USERNAME:PASSWORD@HOST:PORT/DATABASE`

### Environment Variables

Set database URL via environment variable:

```bash
export DATABASE_URL="postgresql+asyncpg://user:password@host:5432/db"
```

Alembic will use this automatically if `sqlalchemy.url` is not set in `alembic.ini`.

## Migration Scripts

### migrate.sh - Apply Migrations

Applies pending migrations to the database.

```bash
# Apply all pending migrations (default)
./scripts/migrate.sh

# Apply to specific revision
./scripts/migrate.sh 001
./scripts/migrate.sh 002_add_certificates

# Apply with verbose output
./scripts/migrate.sh head --verbose

# Show help
./scripts/migrate.sh -h
```

**Features**:
- Automatic database connection verification
- Shows current and target revisions
- Displays migration history
- Colored output for easy reading
- Error handling and rollback on failure

### migrate-down.sh - Downgrade Migrations

Reverts migrations to a previous state. **WARNING: This deletes data!**

```bash
# Downgrade one step
./scripts/migrate-down.sh -1

# Downgrade two steps
./scripts/migrate-down.sh -2

# Downgrade to initial state
./scripts/migrate-down.sh base

# Downgrade to specific revision
./scripts/migrate-down.sh 001

# Force without confirmation
./scripts/migrate-down.sh -1 --force

# Show help
./scripts/migrate-down.sh -h
```

**Features**:
- Requires confirmation (use `--force` to skip)
- Shows data loss warning
- Displays current and target state
- Backup recommendation

### migrate-status.sh - Check Status

Displays current migration status and history.

```bash
./scripts/migrate-status.sh
```

**Output includes**:
- Database connection information
- Current applied revision
- Available branches
- Complete migration history
- Common commands

### migrate-create.sh - Create New Migration

Creates a new migration file based on model changes.

```bash
# Create autogenerated migration (default)
./scripts/migrate-create.sh "Add certificate table"

# Create empty migration for manual SQL
./scripts/migrate-create.sh "Fix user constraints" --manual

# Show help
./scripts/migrate-create.sh -h
```

**Modes**:
- `--autogenerate`: Generates from SQLAlchemy model changes
- `--manual`: Creates empty migration for custom SQL

## Database Schema

### Initial Migration (001)

Creates complete MarchProxy schema:

#### Core Tables

**auth_user**
- User authentication and 2FA configuration
- Indexes: email (unique), username (unique)

**clusters**
- Cluster definitions with logging configuration
- Multi-cluster support for Enterprise tier
- Indexes: name (unique), is_active
- Foreign key: created_by -> auth_user

**services**
- Service definitions with protocol and auth configuration
- Supports TCP, UDP, ICMP, HTTPS, HTTP3/QUIC
- Indexes: name (unique), cluster_id, is_active
- Foreign keys: cluster_id, created_by

**proxy_servers**
- Proxy server registration and status
- License validation tracking
- Indexes: name (unique), cluster_id, status
- Foreign key: cluster_id

**proxy_metrics**
- Performance metrics from proxies
- CPU, memory, connections, throughput, latency
- Indexes: proxy_id, timestamp
- Foreign key: proxy_id

#### Access Control Tables

**user_cluster_assignments**
- RBAC: User to cluster mappings
- Unique constraint: user_id + cluster_id
- Foreign keys: user_id, cluster_id, assigned_by

**user_service_assignments**
- RBAC: User to service mappings
- Unique constraint: user_id + service_id
- Foreign keys: user_id, service_id, assigned_by

#### Certificate Management

**certificates**
- TLS certificate storage and renewal
- Supports: Infisical, HashiCorp Vault, direct upload
- Auto-renewal configuration
- Indexes: name (unique), valid_until, is_active
- Foreign key: created_by

#### Enterprise Features

**qos_policies** - Traffic shaping
- Bandwidth limits and priority queues
- JSON-based configuration
- Index: service_id + cluster_id

**route_tables** - Multi-cloud routing
- Routing algorithms: latency, cost, geo, weighted_rr, failover
- Health probe configuration
- Index: service_id + cluster_id

**route_health_status** - Route health tracking
- Per-endpoint health status
- RTT and failure tracking
- Index: route_table_id + endpoint

**tracing_configs** - Observability
- Tracing backends: Jaeger, Zipkin, OTLP
- Sampling strategies
- Index: cluster_id

**tracing_stats** - Tracing statistics
- Span counts and duration metrics
- Index: tracing_config_id + timestamp

## Creating Migrations

### From Model Changes (Autogenerate)

When you modify SQLAlchemy models:

1. Update model files in `app/models/sqlalchemy/`
2. Create migration:
   ```bash
   ./scripts/migrate-create.sh "Add new field to service"
   ```
3. Alembic automatically detects schema changes
4. Review generated migration file
5. Apply migration:
   ```bash
   ./scripts/migrate.sh
   ```

### Manual SQL Migrations

For complex changes not easily expressed in models:

1. Create empty migration:
   ```bash
   ./scripts/migrate-create.sh "Complex data transformation" --manual
   ```
2. Edit generated file in `alembic/versions/`
3. Implement custom SQL in `upgrade()` and `downgrade()`
4. Test thoroughly before applying

### Migration Template

Generated migrations follow this structure:

```python
"""Migration description.

Revision ID: 002
Revises: 001
Create Date: 2025-12-12 15:30:00.000000

"""
from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa

revision: str = '002'
down_revision: Union[str, None] = '001'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None

def upgrade() -> None:
    # Add your upgrade logic here
    pass

def downgrade() -> None:
    # Add your downgrade logic here
    pass
```

## Best Practices

### Before Creating Migrations

- Ensure models in `app/models/sqlalchemy/` are up to date
- Keep model files focused and well-organized
- Use proper column types and constraints

### When Creating Migrations

- Write descriptive messages explaining the change
- Always test on development database first
- Review generated migrations carefully
- Include both upgrade and downgrade logic

### During Deployment

- Test migrations on production-like database
- Have backups before running downgrades
- Run migrations during maintenance windows
- Monitor migration execution time

### Migration Naming

Convention: `NNN_short_description.py`
- Leading numbers: revision order (001, 002, etc.)
- Underscores, lowercase, concise descriptions
- Maximum 25,000 characters per migration file

Examples:
- `001_initial_schema.py`
- `002_add_certificates.py`
- `003_add_qos_policies.py`
- `004_add_enterprise_tracing.py`

## Async SQLAlchemy Support

MarchProxy uses async SQLAlchemy with asyncpg driver.

### async Environment Configuration

File: `alembic/env.py`

```python
# Async engine creation
connectable = async_engine_from_config(
    config.get_section(config.config_ini_section, {}),
    prefix="sqlalchemy.",
    poolclass=pool.NullPool,
)

# Async connection handling
async with connectable.connect() as connection:
    await connection.run_sync(do_run_migrations)
```

This allows:
- Non-blocking database operations
- Proper async context management
- Connection pooling for performance

## Docker Integration

### Running Migrations in Docker

```bash
# In docker-compose.yml
services:
  api-server:
    build: ./api-server
    environment:
      DATABASE_URL: postgresql+asyncpg://user:pass@postgres:5432/db
    command: sh -c "alembic -c alembic.ini upgrade head && uvicorn app.main:app --host 0.0.0.0"
    depends_on:
      - postgres
```

### Docker Build Script

```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

# Run migrations before starting application
CMD ["sh", "-c", "alembic -c alembic.ini upgrade head && uvicorn app.main:app --host 0.0.0.0"]
```

## Troubleshooting

### Connection Errors

```bash
# Check database URL configuration
grep sqlalchemy.url alembic.ini

# Test connection manually
python -c "from app.config import get_settings; print(get_settings().DATABASE_URL)"
```

### Migration Conflicts

```bash
# Check current status
./scripts/migrate-status.sh

# View migration history
alembic -c alembic.ini history -i
```

### Reverting Failed Migrations

```bash
# If migration partially applied, downgrade before retrying
./scripts/migrate-down.sh -1

# Fix the migration file
nano alembic/versions/NNN_migration.py

# Try again
./scripts/migrate.sh
```

### Table Already Exists

```bash
# If migration fails because table exists, check current state
./scripts/migrate-status.sh

# May need to manually update alembic_version table
# (only if recovery is needed - consult documentation)
```

## Advanced Usage

### Offline Migrations

For databases without direct Python connection:

```bash
alembic -c alembic.ini upgrade --sql head > migration.sql
# Review migration.sql then apply manually
```

### Creating Branches

```bash
# Create branching migration
alembic -c alembic.ini revision -b feature --head=002 -m "Feature branch"
```

### Revision Targeting

```bash
# Upgrade to specific revision
alembic -c alembic.ini upgrade 002

# Upgrade relative to current
alembic -c alembic.ini upgrade +2  # 2 steps forward
alembic -c alembic.ini downgrade -1  # 1 step back
```

## References

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [Async SQLAlchemy](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html)
- [PostgreSQL asyncpg](https://magicstack.github.io/asyncpg/)
- [SQLAlchemy Column Types](https://docs.sqlalchemy.org/en/20/core/types.html)

## Support

For migration issues:
1. Check migration history: `./scripts/migrate-status.sh`
2. Review migration file in `alembic/versions/`
3. Check database logs for errors
4. Test on development environment first
5. Consult Alembic documentation

## Version History

### v1.0.0 (2025-12-12)
- Initial Alembic setup
- Complete schema migration (001)
- Migration helper scripts
- Async SQLAlchemy support
- PostgreSQL optimized
