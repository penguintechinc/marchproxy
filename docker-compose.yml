# MarchProxy Unified NLB Architecture - Docker Compose
# Version: v1.0.0
# Architecture: NLB (L3/L4) + ALB (L7) + DBLB + AILB + RTMP modules

version: '3.8'

services:
  # ============================================================================
  # Infrastructure Services
  # ============================================================================

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: marchproxy-postgres
    environment:
      POSTGRES_DB: marchproxy
      POSTGRES_USER: marchproxy
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-marchproxy123}
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - marchproxy-internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U marchproxy"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: marchproxy-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis123}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - marchproxy-internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ============================================================================
  # MarchProxy Core Services
  # ============================================================================

  # API Server (FastAPI) - Management & xDS Control Plane
  api-server:
    build:
      context: ./api-server
      dockerfile: Dockerfile
    container_name: marchproxy-api-server
    environment:
      # Database
      - DATABASE_URL=postgresql+asyncpg://marchproxy:${POSTGRES_PASSWORD:-marchproxy123}@postgres:5432/marchproxy
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis123}@redis:6379/0

      # Application
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-this}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # xDS Control Plane
      - XDS_GRPC_PORT=18000
      - XDS_GRPC_BIND=0.0.0.0:18000

      # License
      - LICENSE_KEY=${LICENSE_KEY:-}
      - LICENSE_SERVER_URL=${LICENSE_SERVER_URL:-https://license.penguintech.io}

      # CORS
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://webui:3000}

      # Observability
      - JAEGER_ENABLED=${JAEGER_ENABLED:-true}
      - JAEGER_HOST=jaeger
      - JAEGER_PORT=6831
    ports:
      - "8000:8000"   # REST API
      - "18000:18000" # xDS gRPC
    networks:
      - marchproxy-internal
      - marchproxy-external
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - "service=marchproxy-api-server"
      - "component=api"

  # Web UI (React + Vite)
  webui:
    build:
      context: ./webui
      dockerfile: Dockerfile
    container_name: marchproxy-webui
    environment:
      - VITE_API_URL=http://api-server:8000
      - VITE_JAEGER_URL=http://jaeger:16686
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=3000
    ports:
      - "3000:3000"
    networks:
      - marchproxy-internal
      - marchproxy-external
    depends_on:
      - api-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - "service=marchproxy-webui"
      - "component=ui"

  # ============================================================================
  # MarchProxy Unified NLB Architecture
  # ============================================================================

  # NLB Container - Single Entry Point (L3/L4)
  proxy-nlb:
    build:
      context: ./proxy-nlb
      dockerfile: Dockerfile
    container_name: marchproxy-proxy-nlb
    environment:
      # API Server connection
      - API_SERVER_URL=http://api-server:8000
      - XDS_SERVER=api-server:18000
      - CLUSTER_API_KEY=${CLUSTER_API_KEY:-default-api-key}

      # Proxy configuration
      - PROXY_NAME=${PROXY_NLB_NAME:-proxy-nlb-1}
      - LISTEN_PORT=${NLB_PORT:-7000}
      - ADMIN_PORT=7001
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Module gRPC endpoints (internal network)
      - ALB_GRPC=proxy-alb:50051
      - DBLB_GRPC=proxy-dblb:50052
      - AILB_GRPC=proxy-ailb:50053
      - RTMP_GRPC=proxy-rtmp:50054

      # Network acceleration
      - ENABLE_EBPF=${ENABLE_EBPF:-true}
      - ENABLE_XDP=${ENABLE_XDP:-false}
      - ENABLE_AF_XDP=${ENABLE_AF_XDP:-false}

      # Rate limiting
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_RPS=${RATE_LIMIT_RPS:-10000}

      # Auto-scaling
      - AUTO_SCALING_ENABLED=${AUTO_SCALING_ENABLED:-false}
      - SCALE_MIN_INSTANCES=${SCALE_MIN_INSTANCES:-1}
      - SCALE_MAX_INSTANCES=${SCALE_MAX_INSTANCES:-10}

      # Blue/Green deployments
      - BLUE_GREEN_ENABLED=${BLUE_GREEN_ENABLED:-false}

      # Observability
      - JAEGER_ENABLED=${JAEGER_ENABLED:-true}
      - JAEGER_HOST=jaeger
      - JAEGER_PORT=6831
    ports:
      - "${NLB_PORT:-7000}:${NLB_PORT:-7000}"  # Main entry point
      - "7001:7001"  # Admin/Metrics
    networks:
      - marchproxy-internal
      - marchproxy-external
    cap_add:
      - NET_ADMIN
      - SYS_RESOURCE
    depends_on:
      - api-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7001/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - "service=marchproxy-proxy-nlb"
      - "component=proxy"
      - "layer=network"

  # ALB Container - Application Load Balancer (L7 Envoy)
  proxy-alb:
    build:
      context: ./proxy-l7
      dockerfile: Dockerfile
    container_name: marchproxy-proxy-alb
    environment:
      # xDS control plane
      - XDS_SERVER=api-server:18000
      - CLUSTER_API_KEY=${CLUSTER_API_KEY:-default-api-key}

      # Envoy configuration
      - ENVOY_LOG_LEVEL=${ENVOY_LOG_LEVEL:-info}
      - NUM_WORKERS=${NUM_WORKERS:-4}

      # gRPC server (ModuleService)
      - GRPC_PORT=50051
      - GRPC_BIND=0.0.0.0:50051

      # Module configuration
      - MODULE_TYPE=alb
      - MODULE_NAME=${ALB_NAME:-proxy-alb-1}

      # Rate limiting per route
      - RATE_LIMIT_ENABLED=${ALB_RATE_LIMIT:-true}

      # Observability
      - JAEGER_ENABLED=${JAEGER_ENABLED:-true}
      - JAEGER_HOST=jaeger
      - JAEGER_PORT=6831
    ports:
      - "80:80"       # HTTP
      - "443:443"     # HTTPS
      - "8080:8080"   # HTTP/2
      - "9901:9901"   # Envoy admin
      - "50051:50051" # gRPC ModuleService
    networks:
      - marchproxy-internal
    cap_add:
      - NET_ADMIN
    depends_on:
      - api-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9901/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - "service=marchproxy-proxy-alb"
      - "component=proxy"
      - "layer=application"
      - "module=alb"

  # DBLB Container - Database Load Balancer (ArticDBM)
  proxy-dblb:
    build:
      context: ./proxy-dblb
      dockerfile: Dockerfile
    container_name: marchproxy-proxy-dblb
    profiles:
      - full
      - dblb
    environment:
      # API Server connection
      - API_SERVER_URL=http://api-server:8000
      - CLUSTER_API_KEY=${CLUSTER_API_KEY:-default-api-key}

      # gRPC server (ModuleService)
      - GRPC_PORT=50052
      - GRPC_BIND=0.0.0.0:50052

      # Module configuration
      - MODULE_TYPE=dblb
      - MODULE_NAME=${DBLB_NAME:-proxy-dblb-1}
      - ADMIN_PORT=7002
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Database proxy ports
      - MYSQL_PORT=3306
      - POSTGRESQL_PORT=5432
      - MONGODB_PORT=27017
      - REDIS_PORT=6380
      - MSSQL_PORT=1433

      # Connection pooling
      - POOL_SIZE=${DBLB_POOL_SIZE:-100}
      - POOL_MAX_OVERFLOW=${DBLB_POOL_MAX:-200}

      # Security
      - SQL_INJECTION_CHECK=${SQL_INJECTION_CHECK:-true}

      # Rate limiting per database route
      - RATE_LIMIT_ENABLED=${DBLB_RATE_LIMIT:-true}

      # Observability
      - JAEGER_ENABLED=${JAEGER_ENABLED:-true}
      - JAEGER_HOST=jaeger
      - JAEGER_PORT=6831
    ports:
      - "3306:3306"   # MySQL
      - "5433:5432"   # PostgreSQL (offset to avoid conflict)
      - "27017:27017" # MongoDB
      - "6380:6380"   # Redis (offset)
      - "1433:1433"   # MSSQL
      - "7002:7002"   # Admin/Metrics
      - "50052:50052" # gRPC ModuleService
    networks:
      - marchproxy-internal
    depends_on:
      - api-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7002/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - "service=marchproxy-proxy-dblb"
      - "component=proxy"
      - "layer=database"
      - "module=dblb"

  # AILB Container - AI/LLM Load Balancer (WaddleAI)
  proxy-ailb:
    build:
      context: ./proxy-ailb
      dockerfile: Dockerfile
    container_name: marchproxy-proxy-ailb
    profiles:
      - full
      - ailb
    environment:
      # API Server connection
      - API_SERVER_URL=http://api-server:8000
      - CLUSTER_API_KEY=${CLUSTER_API_KEY:-default-api-key}

      # gRPC server (ModuleService)
      - GRPC_PORT=50053
      - GRPC_BIND=0.0.0.0:50053

      # Module configuration
      - MODULE_TYPE=ailb
      - MODULE_NAME=${AILB_NAME:-proxy-ailb-1}
      - HTTP_PORT=7003
      - ADMIN_PORT=7004
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # AI Provider API keys (from environment)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OLLAMA_URL=${OLLAMA_URL:-http://ollama:11434}

      # Conversation memory
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis123}@redis:6379/1

      # RAG configuration
      - RAG_ENABLED=${RAG_ENABLED:-false}
      - RAG_VECTOR_STORE=${RAG_VECTOR_STORE:-faiss}

      # Rate limiting per AI provider route
      - RATE_LIMIT_ENABLED=${AILB_RATE_LIMIT:-true}
      - RATE_LIMIT_RPM=${AILB_RATE_LIMIT_RPM:-60}

      # Observability
      - JAEGER_ENABLED=${JAEGER_ENABLED:-true}
      - JAEGER_HOST=jaeger
      - JAEGER_PORT=6831
    ports:
      - "7003:7003"   # HTTP API
      - "7004:7004"   # Admin/Metrics
      - "50053:50053" # gRPC ModuleService
    networks:
      - marchproxy-internal
    depends_on:
      - api-server
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7004/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - "service=marchproxy-proxy-ailb"
      - "component=proxy"
      - "layer=ai"
      - "module=ailb"

  # RTMP Container - Video Transcoding (CPU variant)
  proxy-rtmp:
    build:
      context: ./proxy-rtmp
      dockerfile: Dockerfile
      target: cpu
    container_name: marchproxy-proxy-rtmp
    profiles:
      - full
      - rtmp
    environment:
      # API Server connection
      - API_SERVER_URL=http://api-server:8000
      - CLUSTER_API_KEY=${CLUSTER_API_KEY:-default-api-key}

      # gRPC server (ModuleService)
      - GRPC_PORT=50054
      - GRPC_BIND=0.0.0.0:50054

      # Module configuration
      - MODULE_TYPE=rtmp
      - MODULE_NAME=${RTMP_NAME:-proxy-rtmp-1}
      - RTMP_PORT=1935
      - ADMIN_PORT=7005
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # FFmpeg configuration
      - FFMPEG_THREADS=${FFMPEG_THREADS:-4}
      - TRANSCODE_PRESET=${TRANSCODE_PRESET:-medium}
      - VIDEO_CODEC=${VIDEO_CODEC:-x264}

      # Output formats
      - HLS_ENABLED=${HLS_ENABLED:-true}
      - HLS_SEGMENT_DURATION=${HLS_SEGMENT_DURATION:-6}
      - DASH_ENABLED=${DASH_ENABLED:-false}

      # Rate limiting per stream
      - RATE_LIMIT_ENABLED=${RTMP_RATE_LIMIT:-true}

      # Observability
      - JAEGER_ENABLED=${JAEGER_ENABLED:-true}
      - JAEGER_HOST=jaeger
      - JAEGER_PORT=6831
    ports:
      - "1935:1935"   # RTMP
      - "8081:8081"   # HLS/DASH HTTP
      - "7005:7005"   # Admin/Metrics
      - "50054:50054" # gRPC ModuleService
    volumes:
      - rtmp_streams:/streams
    networks:
      - marchproxy-internal
    depends_on:
      - api-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7005/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - "service=marchproxy-proxy-rtmp"
      - "component=proxy"
      - "layer=video"
      - "module=rtmp"
      - "variant=cpu"

  # ============================================================================
  # Observability Stack
  # ============================================================================

  # Jaeger for distributed tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: marchproxy-jaeger
    environment:
      - COLLECTOR_ZIPKIN_HTTP_PORT=9411
      - MEMORY_MAX_TRACES=10000
    ports:
      - "5775:5775/udp"
      - "6831:6831/udp"
      - "6832:6832/udp"
      - "5778:5778"
      - "16686:16686"  # Jaeger UI
      - "14268:14268"
      - "14250:14250"
      - "9411:9411"
    networks:
      - marchproxy-internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:16686"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "service=marchproxy-jaeger"
      - "component=observability"

  # Prometheus for metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: marchproxy-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    volumes:
      - ./monitoring/prometheus:/etc/prometheus
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - marchproxy-internal
    restart: unless-stopped

  # Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: marchproxy-grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    ports:
      - "3001:3000"  # Offset to avoid conflict with webui
    networks:
      - marchproxy-internal
    depends_on:
      - prometheus
    restart: unless-stopped

# ============================================================================
# Networks
# ============================================================================
networks:
  marchproxy-internal:
    driver: bridge
    internal: false  # Needs external access for license validation
    ipam:
      config:
        - subnet: 172.20.0.0/16
    labels:
      - "network=marchproxy-internal"
      - "purpose=grpc-communication"

  marchproxy-external:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
    labels:
      - "network=marchproxy-external"
      - "purpose=public-access"

# ============================================================================
# Volumes
# ============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  rtmp_streams:
    driver: local
