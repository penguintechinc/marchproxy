<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clusters - MarchProxy</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
</head>
<body>
    <nav class="navbar is-dark" role="navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="[[=URL('dashboard')]]">
                <strong>MarchProxy</strong>
            </a>
        </div>
        
        <div class="navbar-menu">
            <div class="navbar-start">
                <a class="navbar-item" href="[[=URL('dashboard')]]">Dashboard</a>
                <a class="navbar-item is-active" href="[[=URL('clusters')]]">Clusters</a>
                <a class="navbar-item" href="[[=URL('services')]]">Services</a>
                [[if user.is_admin:]]
                <a class="navbar-item" href="[[=URL('users')]]">Users</a>
                [[pass]]
            </div>
            
            <div class="navbar-end">
                <div class="navbar-item has-dropdown is-hoverable">
                    <a class="navbar-link">
                        [[=user.username]]
                    </a>
                    <div class="navbar-dropdown">
                        <a class="navbar-item" href="[[=URL('auth/setup-2fa')]]">2FA Setup</a>
                        <hr class="navbar-divider">
                        <a class="navbar-item" href="[[=URL('auth/logout')]]">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <div class="level">
                <div class="level-left">
                    <div class="level-item">
                        <h1 class="title">Cluster Management</h1>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        [[if user.is_admin:]]
                        <a class="button is-primary" href="[[=URL('clusters/create')]]">
                            <span class="icon"><i class="fas fa-plus"></i></span>
                            <span>Create Cluster</span>
                        </a>
                        [[pass]]
                    </div>
                </div>
            </div>
            
            [[if clusters:]]
            <div class="columns is-multiline">
                [[for cluster in clusters:]]
                <div class="column is-one-third">
                    <div class="card">
                        <div class="card-header">
                            <p class="card-header-title">
                                [[=cluster.name]]
                                [[if cluster.is_default:]]
                                <span class="tag is-info is-small ml-2">Default</span>
                                [[pass]]
                            </p>
                            <button class="card-header-icon dropdown is-hoverable">
                                <div class="dropdown-trigger">
                                    <span class="icon">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </span>
                                </div>
                                <div class="dropdown-menu" role="menu">
                                    <div class="dropdown-content">
                                        <a class="dropdown-item" href="[[=URL('clusters/edit', cluster.id)]]">
                                            <span class="icon is-small"><i class="fas fa-edit"></i></span>
                                            Edit
                                        </a>
                                        [[if user.is_admin:]]
                                        <a class="dropdown-item" href="#" onclick="rotateApiKey([[=cluster.id]])">
                                            <span class="icon is-small"><i class="fas fa-key"></i></span>
                                            Rotate API Key
                                        </a>
                                        <hr class="dropdown-divider">
                                        <a class="dropdown-item has-text-danger" href="#" onclick="deleteCluster([[=cluster.id]], '[[=cluster.name]]')">
                                            <span class="icon is-small"><i class="fas fa-trash"></i></span>
                                            Delete
                                        </a>
                                        [[pass]]
                                    </div>
                                </div>
                            </button>
                        </div>
                        
                        <div class="card-content">
                            <div class="content">
                                <p><strong>Description:</strong> [[=cluster.description or 'No description']]</p>
                                <p><strong>Max Proxies:</strong> [[=cluster.max_proxies]]</p>
                                <p><strong>Active Proxies:</strong> [[=cluster.proxy_count or 0]]</p>
                                
                                <!-- Logging Configuration -->
                                <div class="field is-grouped is-grouped-multiline">
                                    <div class="control">
                                        <div class="tags has-addons">
                                            <span class="tag is-dark">Auth Logs</span>
                                            <span class="tag [[if cluster.log_auth:]]is-success[[else:]]is-light[[pass]]">
                                                [[if cluster.log_auth:]]ON[[else:]]OFF[[pass]]
                                            </span>
                                        </div>
                                    </div>
                                    <div class="control">
                                        <div class="tags has-addons">
                                            <span class="tag is-dark">NetFlow</span>
                                            <span class="tag [[if cluster.log_netflow:]]is-success[[else:]]is-light[[pass]]">
                                                [[if cluster.log_netflow:]]ON[[else:]]OFF[[pass]]
                                            </span>
                                        </div>
                                    </div>
                                    <div class="control">
                                        <div class="tags has-addons">
                                            <span class="tag is-dark">Debug</span>
                                            <span class="tag [[if cluster.log_debug:]]is-warning[[else:]]is-light[[pass]]">
                                                [[if cluster.log_debug:]]ON[[else:]]OFF[[pass]]
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                [[if cluster.syslog_endpoint:]]
                                <p><strong>Syslog:</strong> [[=cluster.syslog_endpoint]]</p>
                                [[pass]]
                            </div>
                        </div>
                        
                        <div class="card-footer">
                            <div class="card-footer-item">
                                <span class="tag [[if cluster.is_active:]]is-success[[else:]]is-danger[[pass]]">
                                    [[if cluster.is_active:]]Active[[else:]]Inactive[[pass]]
                                </span>
                            </div>
                            <div class="card-footer-item">
                                <small class="has-text-grey">
                                    Created: [[=cluster.created_at.strftime('%Y-%m-%d') if cluster.created_at else 'Unknown']]
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                [[pass]]
            </div>
            [[else:]]
            <div class="notification is-info">
                <p><strong>No clusters configured.</strong></p>
                [[if user.is_admin:]]
                <p>Create your first cluster to start organizing your proxy servers.</p>
                <br>
                <a class="button is-primary" href="[[=URL('clusters/create')]]">
                    <span class="icon"><i class="fas fa-plus"></i></span>
                    <span>Create Cluster</span>
                </a>
                [[else:]]
                <p>Contact your administrator to create clusters or assign you to existing ones.</p>
                [[pass]]
            </div>
            [[pass]]
        </div>
    </section>

    <script>
        function rotateApiKey(clusterId) {
            if (confirm('Are you sure you want to rotate the API key for this cluster? All proxy servers will need to be updated with the new key.')) {
                fetch(`/clusters/${clusterId}/rotate-key`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('API key rotated successfully. New key: ' + data.new_key);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Network error: ' + error);
                });
            }
        }

        function deleteCluster(clusterId, clusterName) {
            if (confirm(`Are you sure you want to delete cluster "${clusterName}"? This action cannot be undone.`)) {
                fetch(`/clusters/${clusterId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Cluster deleted successfully.');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Network error: ' + error);
                });
            }
        }

        // Enable dropdowns
        document.addEventListener('DOMContentLoaded', () => {
            const dropdowns = document.querySelectorAll('.dropdown:not(.is-hoverable)');
            
            if (dropdowns.length > 0) {
                dropdowns.forEach(dropdown => {
                    dropdown.addEventListener('click', (event) => {
                        event.stopPropagation();
                        dropdown.classList.toggle('is-active');
                    });
                });
                
                document.addEventListener('click', () => {
                    dropdowns.forEach(dropdown => {
                        dropdown.classList.remove('is-active');
                    });
                });
            }
        });
    </script>
</body>
</html>