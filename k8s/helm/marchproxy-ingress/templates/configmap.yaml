apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "marchproxy-ingress.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "marchproxy-ingress.labels" . | nindent 4 }}
data:
  # Proxy configuration
  proxy.yaml: |
    proxy:
      type: {{ .Values.config.proxyType }}
      log_level: {{ .Values.config.logLevel }}

      # mTLS configuration
      mtls:
        enabled: {{ .Values.config.mtls.enabled }}
        {{- if .Values.config.mtls.enabled }}
        server_cert: {{ .Values.config.mtls.serverCertPath }}
        server_key: {{ .Values.config.mtls.serverKeyPath }}
        client_ca: {{ .Values.config.mtls.clientCaPath }}
        verify_client: {{ .Values.config.mtls.verifyClient }}
        {{- end }}

      # eBPF/XDP configuration
      ebpf:
        enabled: {{ .Values.config.ebpf.enabled }}
      xdp:
        enabled: {{ .Values.config.xdp.enabled }}
        {{- if .Values.config.xdp.enabled }}
        interface: {{ .Values.config.xdp.interface }}
        {{- end }}

      # Rate limiting
      rate_limit:
        enabled: {{ .Values.config.rateLimit.enabled }}
        {{- if .Values.config.rateLimit.enabled }}
        requests_per_second: {{ .Values.config.rateLimit.requestsPerSecond }}
        burst_size: {{ .Values.config.rateLimit.burstSize }}
        {{- end }}

      # Health check
      health_check:
        enabled: {{ .Values.config.healthCheck.enabled }}
        {{- if .Values.config.healthCheck.enabled }}
        interval: {{ .Values.config.healthCheck.interval }}
        timeout: {{ .Values.config.healthCheck.timeout }}
        unhealthy_threshold: {{ .Values.config.healthCheck.unhealthyThreshold }}
        {{- end }}

      # Connection settings
      connection:
        max_idle_conns: {{ .Values.config.connection.maxIdleConns }}
        max_idle_conns_per_host: {{ .Values.config.connection.maxIdleConnsPerHost }}
        idle_conn_timeout: {{ .Values.config.connection.idleConnTimeout }}
        tls_handshake_timeout: {{ .Values.config.connection.tlsHandshakeTimeout }}
        expect_continue_timeout: {{ .Values.config.connection.expectContinueTimeout }}

  {{- with .Values.configMap.data }}
  {{- toYaml . | nindent 2 }}
  {{- end }}
